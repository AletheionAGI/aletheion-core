name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Get pip cache dir
      id: pip-cache
      run: |
        echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/setup.py', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Verify installation
      run: |
        python -c "from src import q_metric, varo_update, epistemic_gate; print('✓ Import successful')"
        python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --tb=short

    - name: Run tests with coverage
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      run: |
        pytest tests/ --cov=src --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check code formatting with Black
      run: |
        black --check src/ tests/ examples/

    - name: Check import sorting with isort
      run: |
        isort --check-only src/ tests/ examples/

    - name: Type check with mypy
      run: |
        mypy src/ --ignore-missing-imports
      continue-on-error: true  # Don't fail CI on type errors yet

  examples:
    name: Run Examples
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run simple demo
      run: |
        python examples/simple_demo.py

    - name: Run ARC example
      run: |
        python examples/arc_example.py

  build:
    name: Build Distribution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build distribution
      run: |
        python -m build

    - name: Check distribution
      run: |
        twine check dist/*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/

  test-install:
    name: Test Installation from Wheel
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/

    - name: Install from wheel
      run: |
        python -m pip install --upgrade pip
        pip install dist/*.whl

    - name: Test import
      run: |
        python -c "from src import q_metric, varo_update, epistemic_gate; print('✓ Installation successful')"

    - name: Test basic functionality
      run: |
        python -c "
        import numpy as np
        from src import q_metric, varo_update, epistemic_gate

        # Test Q metric
        a = np.array([1.0, 0.0, 0.0])
        b = np.array([1.0, 0.0, 0.0])
        q = q_metric(a, b)
        assert abs(q - 1.0) < 1e-6, f'Q metric test failed: Q={q}'

        # Test VARO
        psi = np.array([1.0, 0.0])
        z = np.array([0.0, 1.0])
        psi_new = varo_update(psi, z, beta=0.5, gamma=0.9)
        assert abs(np.linalg.norm(psi_new) - 1.0) < 1e-6, 'VARO normalization failed'

        # Test epistemic gate
        current = np.array([1.0, 0.0, 0.0])
        proposed = np.array([0.9, 0.1, 0.0])
        target = np.array([1.0, 0.0, 0.0])
        accepted, q, n_bt = epistemic_gate(current, proposed, target, q_min=0.5)
        assert q >= 0.5, f'Epistemic gate test failed: Q={q}'

        print('✓ All functionality tests passed')
        "
